<!DOCTYPE html>
<html>

<head>
    <meta http-equiv=Content-Type content="text/html; charset=utf-8">
    <meta name=viewport content="width=device-width,user-scalable=no,initial-scale=1,maximum-scale=1,minimum-scale=1">
    <style>
        body {
            position: absolute;
            width: 100%;
            height: 100%;
            margin: 0;
            overflow: hidden;
        }

        #myCanvas {
            height: 100%;
            width: 100%;

        }
    </style>
</head>

<body>
    <canvas id="myCanvas"></canvas>
    <script>
        (function init() {
            var canvas = document.getElementById('myCanvas');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            window.bytedGame = {
                firstCanvas: false,
                workerObject: null,
                RAFIdMap: {},
                _fpsInterval: undefined,
                canvas: canvas,
                openContextFile: null,
                openContextCb: () => {},
                sharedCanvas: null,
                shouldSendRequest: null,
                createElement: window.document.createElement.bind(window.document),
                EventHandler: {
                    ontouchstart: null,
                    ontouchmove: null,
                    ontouchcancel: null,
                    ontouchend: null
                },
                readFileSync: window.readFileSync
            };
        })();
        window.NativeGlobal = {
          EventHandler: window.bytedGame.EventHandler,
          // XMLHttpRequest: window.XMLHttpRequest,
          // WebSocket: window.WebSocket,
          // Worker: window.Worker,
          setPreferredFramesPerSecond: function (fps) {
            if (Object.prototype.toString.call(fps).slice(8, -1) === 'Number') {
              if (fps < 1) fps = 1
              else if (fps >= 60) fps = null
              if (fps) {
                  window.bytedGame._fpsInterval = 1000 / fps
              } else {
                  window.bytedGame._fpsInterval = null
              }
            }
          },
          requestAnimationFrame: window.requestAnimationFrame.bind(window),
          cancelAnimationFrame: window.cancelAnimationFrame.bind(window),
          setTimeout: window.setTimeout.bind(window),
          clearTimeout: window.clearTimeout.bind(window),
          setInterval: window.setInterval.bind(window),
          clearInterval: window.clearInterval.bind(window),
          loadFont: function(path){
            return null;
          },
          Canvas: function () {
              let {firstCanvas, createElement} = window.bytedGame;
              if(!firstCanvas){
                  window.bytedGame.firstCanvas = true;
                  return window.bytedGame.canvas;
              }
              var c = createElement('canvas');
              c.width = window.innerWidth;
              c.height = window.innerHeight;
              return c
          },
          createContext(fileName, cb, shouldSendRequest){
              window.bytedGame.openContextFile = fileName;
              window.bytedGame.openContextCb = cb;
              window.bytedGame.shouldSendRequest = shouldSendRequest;
              if(window.bytedGame['subContextIframe'].contentWindow.subContext){
                  window.bytedGame['subContextIframe'].contentWindow.subContext.init();
              }
              let {sharedCanvas, postMessage} = window.bytedGame['subContextIframe'].contentWindow.subContext;
              return {
                    sharedCanvas:  sharedCanvas,
                    postMessage: postMessage
              }
          },
          Image: window.Image,
          Audio: window._byted.audio,
          performanceNow: performance.now.bind(performance),
          createWorker: function () {
              if (typeof(Worker) !== "undefined") {
                  try {
                      window.bytedGame.workerObject = new window._byted.Worker('./workers.js');
                      window.bytedGame.workerObject.onMessage = function (handler) {
                         if(typeof handler === "function"){
                             window.bytedGame.workerObject.onmessage = function(e){
                                 if(typeof handler === "function" && typeof e.data !== "undefined"){
                                     handler(e.data);
                                 }else {
                                     // console.warn("worker onMessage args error!");
                                 }
                             }
                         }
                      };
                  }catch (e) {
                      console.error("createWorker error:", e && e.stack)
                  }
              } else {
                  console.warn("Worker not supported!");
              }
              return window.bytedGame.workerObject;
          }
        };

        ['touchstart', 'touchmove', 'touchcancel', 'touchend'].forEach((type) => {
            window.bytedGame.canvas.addEventListener(type, (e) => {
            const {
              type
            } = e
            const listener = window.bytedGame.EventHandler[type];
            if (typeof listener === 'function') {

                Object.keys(e.changedTouches).forEach(function(item) {
                    Object.defineProperty(e.changedTouches[item], 'target', {
                        value: null
                    })
                })

                Object.keys(e.touches).forEach(function(item) {
                    Object.defineProperty(e.touches[item], 'target', {
                        value: null
                    })
                })

              const eventObj = {
                changedTouches: Array.from(e.changedTouches),
                currentTarget: e.currentTarget,
                target: e.target,
                targetTouches: Array.from(e.targetTouches),
                touches: Array.from(e.touches),
                timeStamp: e.timeStamp,
                type
              };
              listener.call(window.bytedGame.canvas, eventObj)
            }
          })
        });

        // openDataContext
        let parentContext = {};
        window.parentContext = parentContext;
        parentContext.serverPath = `http://127.0.0.1:${window.staticPort}/static/dist/public/${window._byted.hashPath}`;

        parentContext.shareCanvas = (function () {
            var c = document.createElement('canvas');
            c.width = window.innerWidth;
            c.height = window.innerHeight;
            return c;
        })();
        let gameJsPath = `http://127.0.0.1:${window.staticPort}/static/dist/public/${window._byted.hashPath}/game.js`
        let tmgCorePath = window.getTmgCorePath();
        if (window._byted.isOpenDataContext()) {
            initOpenData();

            parentContext.loadTmaCore = function() {
                loadScript(tmgCorePath, function () {
                    loadScript(gameJsPath)
                }) 
                initOnShow()
            } 

            parentContext.getSystemInfo = function () {
                return {
                    innerWidth: window.innerWidth,
                    innerHeight: window.innerHeight
                }
            }
        } else {
            loadScript(tmgCorePath, function () {
                loadScript(gameJsPath)
            })            
            initOnShow()
        }

        function loadScript(url, callback) {
            var domScript = document.createElement('script');
            domScript.src = url;
            domScript.onload = domScript.onreadystatechange = function() {
                if (!this.readyState || 'loaded' === this.readyState || 'complete' === this.readyState) {
                    callback && callback();
                    this.onload = this.onreadystatechange = null;
                    this.parentNode.removeChild(this);
                }
            }
            document.getElementsByTagName('head')[0].appendChild(domScript);
        }
        

        function initOpenData () {
            let subContextIframe = window.bytedGame.createElement('iframe');
            subContextIframe.style.width = '1px';
            subContextIframe.style.height = '1px';
            if(window.staticPort){
                let src = `http://127.0.0.1:${window.staticPort}/static/dist/public/${window._byted.hashPath}/openContext.html`;
                console.log("createContext src", src);
                subContextIframe.setAttribute('src',src);
            }
            window.document.body.appendChild(subContextIframe);
            window.bytedGame['subContextIframe'] = subContextIframe;
        }   
        
        function initOnShow() {
            window.onload = function () {
                window._byted.emitOnShow()
            }
        }

        window.CanvasRenderingContext2D.prototype.clip = function() {
            console.warn('CanvasRenderingContext2D.clip is not supported');
        }

        window.CanvasRenderingContext2D.prototype.isPointInPath = function() {
            console.warn('CanvasRenderingContext2D.isPointInPath is not supported');
        }

        window.CanvasRenderingContext2D.prototype.isPointInStroke = function() {
            console.warn('CanvasRenderingContext2D.isPointInStroke is not supported');
        }

        Object.defineProperty(window.CanvasRenderingContext2D.prototype, 'lineDashOffset', {value: function() {
            console.warn('CanvasRenderingContext2D.lineDashOffset is not supported');
        }})
        
    </script>
</body>

</html>
