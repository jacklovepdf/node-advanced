{"version":3,"sources":["../src/index.js"],"names":["throwError","isNodePattern","blit","src","x","y","srcx","srcy","srcw","srch","cb","constructor","call","bitmap","width","height","Math","round","maxw","maxh","baseImage","scanQuiet","sx","sy","idx","dstIdx","getPixelIndex","r","data","g","b","a","dst","limit255"],"mappings":"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","sourcesContent":["import { throwError, isNodePattern } from '@jimp/utils';\n\nexport default () => ({\n  /**\n   * Blits a source image on to this image\n   * @param {Jimp} src the source Jimp instance\n   * @param {number} x the x position to blit the image\n   * @param {number} y the y position to blit the image\n   * @param {number} srcx (optional) the x position from which to crop the source image\n   * @param {number} srcy (optional) the y position from which to crop the source image\n   * @param {number} srcw (optional) the width to which to crop the source image\n   * @param {number} srch (optional) the height to which to crop the source image\n   * @param {function(Error, Jimp)} cb (optional) a callback for when complete\n   * @returns {Jimp} this for chaining of methods\n   */\n  blit(src, x, y, srcx, srcy, srcw, srch, cb) {\n    if (!(src instanceof this.constructor)) {\n      return throwError.call(this, 'The source must be a Jimp image', cb);\n    }\n\n    if (typeof x !== 'number' || typeof y !== 'number') {\n      return throwError.call(this, 'x and y must be numbers', cb);\n    }\n\n    if (typeof srcx === 'function') {\n      cb = srcx;\n      srcx = 0;\n      srcy = 0;\n      srcw = src.bitmap.width;\n      srch = src.bitmap.height;\n    } else if (\n      typeof srcx === typeof srcy &&\n      typeof srcy === typeof srcw &&\n      typeof srcw === typeof srch\n    ) {\n      srcx = srcx || 0;\n      srcy = srcy || 0;\n      srcw = srcw || src.bitmap.width;\n      srch = srch || src.bitmap.height;\n    } else {\n      return throwError.call(\n        this,\n        'srcx, srcy, srcw, srch must be numbers',\n        cb\n      );\n    }\n\n    // round input\n    x = Math.round(x);\n    y = Math.round(y);\n\n    // round input\n    srcx = Math.round(srcx);\n    srcy = Math.round(srcy);\n    srcw = Math.round(srcw);\n    srch = Math.round(srch);\n\n    const maxw = this.bitmap.width;\n    const maxh = this.bitmap.height;\n    const baseImage = this;\n\n    src.scanQuiet(srcx, srcy, srcw, srch, function(sx, sy, idx) {\n      if (\n        x + sx >= 0 &&\n        y + sy >= 0 &&\n        maxw - x - sx > 0 &&\n        maxh - y - sy > 0\n      ) {\n        const dstIdx = baseImage.getPixelIndex(x + sx - srcx, y + sy - srcy);\n        const src = {\n          r: this.bitmap.data[idx],\n          g: this.bitmap.data[idx + 1],\n          b: this.bitmap.data[idx + 2],\n          a: this.bitmap.data[idx + 3]\n        };\n\n        const dst = {\n          r: baseImage.bitmap.data[dstIdx],\n          g: baseImage.bitmap.data[dstIdx + 1],\n          b: baseImage.bitmap.data[dstIdx + 2],\n          a: baseImage.bitmap.data[dstIdx + 3]\n        };\n\n        baseImage.bitmap.data[dstIdx] =\n          ((src.a * (src.r - dst.r) - dst.r + 255) >> 8) + dst.r;\n        baseImage.bitmap.data[dstIdx + 1] =\n          ((src.a * (src.g - dst.g) - dst.g + 255) >> 8) + dst.g;\n        baseImage.bitmap.data[dstIdx + 2] =\n          ((src.a * (src.b - dst.b) - dst.b + 255) >> 8) + dst.b;\n        baseImage.bitmap.data[dstIdx + 3] = this.constructor.limit255(\n          dst.a + src.a\n        );\n      }\n    });\n\n    if (isNodePattern(cb)) {\n      cb.call(this, null, this);\n    }\n\n    return this;\n  }\n});\n"],"file":"index.js"}